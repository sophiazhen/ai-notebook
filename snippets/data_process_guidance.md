# VM数据规范及流程
## 1. 目的与适用范围
本文档用于定义虚拟量测建模所需的数据规范、处理流程与质量要求。当前以 CMP（如 STI CMP）为参考示例进行说明，但规范本身不依赖于具体工艺实现。
适用场景包括：
1. Wafer 级 / Zone 级虚拟量测建模
1. 离线训练集构建
1. 在线预测数据准备
## 2. 数据层级定义
VM 数据按粒度分为两类：
1. WAFER 级数据（Wafer-level）：
    1. 每条记录对应一片 wafer 的整体工艺状态
    1. 用于全片厚度、均值类 VM 建模
1. ZONE 级数据（Zone-level）：
    1. 每条记录对应 wafer 上的一个空间区域（Zone / Area）
    1. 用于局部厚度 VM 建模
两类数据在特征来源、处理流程、质量规则上基本保持一致，仅在空间拆分逻辑上不同。
## 3. 数据组成
每条 VM 数据由以下三大类数据构成：
### 3.1 SPC 数据（y相关）
SPC 数据用于描述与y相关的特征
必须包含的数据类型：
1. 工艺前量测值（PRE_XXX，是x的一部分）
1. 工艺后量测值（PST_XXX，可能作为y）
字段组成：
1. MEASUREMENT_TIME：量测时间
1. RAW_VALUE：原始量测值（一片wafer的by site 数据）
1. EXT_MEAN：原始量测值（一片wafer平均数据）
1. MEASUREMENT_EQUIPMENT：量测设备
说明：
1. RAW_VALUE 在 Wafer 级与 Zone 级的处理方式不同（见第 5 章）
1. 工艺后量值可能有多种，需要根据具体情况决定哪些作为y哪些作为x
### 3.2 FDC 数据
FDC 数据用于描述一片wafer的Process过程中的状态，是 VM 的主要输入特征来源。
数据来源包括：
1. 统计 Chart 直接采集的数据
1. Trace Data API 获取的时序原始数据（作为补充）
FDC 数据应包含：
1. WAFER基本信息，如WAFER_ID、LOT_ID、RECIPE、STAGE、MODULE等
1. 各特征值，包含多统计方式（mean / max / min / std 等）
### 3.3 衍生特征数据
衍生特征通过 SPC 与 FDC 数据计算得到，用于增强模型表达能力，包括但不限于：
1. 使用寿命类特征，用于描述工艺进行时对应设备的老化程度
1. MIX 交叉特征，是基础特征之间的计算值，如在STI_CMP工艺中将PAD的转速与HEAD转速相乘
1. 时序聚合特征（如 WMA）
所有衍生特征需满足：
1. 计算公式明确
1. 可反向校验
1. 不依赖未来信息（防止数据泄漏）
## 4. 数据重命名规范
本章节定义虚拟量测中所有特征字段的统一命名规则，目标是保证数据在跨工艺、跨设备、跨模块、跨模型使用时具备一致的语义表达、可解析性和可扩展性。

### 4.1 总体原则
1.	基础索引与标识字段保持原名，不参与重命名：
1. 如：WAFER_ID、LOT_ID、RECIPE_ID、TOOL_ID、STEP_ID、TIME_STAMP 等
1. 作为 VM 数据集的主键、索引或 Join Key
2.	除基础字段外，所有特征统一采用结构化命名规则，能够从字段名中直接解析出：
1. 特征类型（前值 / 后值 / FDC 原始 / FDC 衍生）
1. 所属工艺或模块
1. 特征物理或统计语义
3.	命名规则需满足：
1. 语义清晰（人可读）
1. 规则稳定（不可随意修改）
1. 编号可扩展（新增特征不影响历史数据）

### 4.2 命名结构总览
除基础字段外，特征字段统一采用如下结构之一：
1. 前后值特征：<前缀>\_<作用范围/类型>\_<工艺路径>\_<结果量>\_<五位数编号>
1. FDC 原始特征：P<Module/Step>\_<作用范围/类型>\_<特征缩写>\_<五位数编号>
1. FDC 衍生特征：P<Module/Step>\_MIX\_{<原始作用范围/类型>\_<原始特征缩写>}\_AXXXX

### 4.3 前值 / 后值特征命名规范
#### 4.3.1 定义
前值（PRE）与后值（PST）特征用于描述：
某一道目标工艺（或工艺组合）在执行前 / 执行后，对关键结果量或质量状态量的量测值或估计值
#### 4.3.2 命名结构
<前缀>\_<作用范围/类型>\_<工艺路径缩写>\_<结果量缩写>\_<五位数编号>
#### 4.3.3 字段说明
1. 前缀

| 前缀 | 含义 |
| --- | --- |
| PRE | 工艺执行前 |
| PST | 工艺执行后 |

2.	作用范围/类型
当前前后值作用范围均为代表整个wafer，因此作用范围为GLB
可根据实际情况扩展
3.	工艺路径缩写
	用于明确结果量从属于哪一道目标工艺
	命名应与 FAB 实际工艺 Flow 保持一致
如STI_CMP、ETCH等
4.	结果量缩写
该字段表示工艺完成后或前的结果量，如THK、OCD等
5.	五位数编号

| 类型 | 编号段 |
| --- | --- |
| PRE | 7XXXX |
| PST | 8XXXX |

- 编号需全局唯一
- 单调递增，不可回收或复用
#### 4.3.4 示例
PRE_GLB_ETCH_OCD_71001
PST_GLB_STI_CMP_OCD_81001

### 4.4 FDC 原始特征命名规范
#### 4.4.1 基本结构
P<Module/Step编号>\_<作用范围/类型>\_<特征缩写>\_<五位数编号>
#### 4.4.2 Module/Step编号说明
Module 编号由工艺路径定义，示例如下：

| Module | 含义 |
| --- | --- |
| P1 | 粗磨 |
| P2 | 精磨 |
| P3 | 清洗 |

五位数编号首位应与其保持一致。
#### 4.4.3 作用范围/类型说明
FDC原始参数的会与不同物理部件相关，如研磨头、研磨垫、研磨液等，示例如下

| 作用范围/类型 | 含义 |
| --- | --- |
| HEAD | 研磨头 |
| PAD | 研磨垫 |
| SLY | 研磨液 |

#### 4.4.4 示例
P1_HEAD_AB_PRS_10001
P2_PAD_TEMP_20001
P3_SLY_FR_30001
### 4.5 FDC 衍生特征命名规范
#### 4.5.1 基本结构
P<Module/Step编号>\_MIX\_{<原始作用范围/类型>\_<原始特征缩写>}\_<五位数编号>
#### 4.5.2 Module/Step编号说明
同4.4.2
#### 4.5.3 原始作用范围/类型_原始特征缩写
FDC衍生特征是通过FDC原始特征组合计算而来的，衍生特征需要保留特定的字段以使衍生特征可读性高，需保留原始作用范围/类型和原始特征缩写。
1. 相同作用范围的特征相组合
此时只保留一次作用范围即可
如P1_HEAD_PRS_10001与P1_HEAD_FR_10002相乘后的衍生特征应命名为P1_MIX_HEAD_PRS_FR_A0001
1. 不同作用范围的特征相组合
此时需保留每次作用范围
如P1_HEAD_PRS_10001与P1_PAD_PRS_10003相乘后的衍生特征应命名为P1_MIX_HEAD_PRS_PAD_PRS_A0002
#### 4.5.4 示例
P1_MIX_HEAD_PRS_FR_A0001
P2_MIX_HEAD_PRS_PAD_PRS_A0002
## 5. Wafer 级与 Zone 级数据差异
### 5.1 Zone 拆分原则
当 FDC 或 SPC 参数以 空间区域（AREA / ZONE） 形式存在时：
1. 原始 Wafer 级字段示例：
HEAD_AREA1_AB_PRS_xxxx
1. 需拆分为：
    1. AREA = 1
    1. HEAD_AB_PRS = value
从而将：
1. 1 行 Wafer 数据 → N 行 Zone 数据
N 的取值由实际工艺定义
### 5.2 SPC 数据在 Zone 级的处理
1. Wafer 级：
    1. 使用 RAW_VALUE 直接计算整体前后值
1. Zone 级：
    1. 保留 RAW_VALUE
    1. 基于 site–zone mapping 重新计算每个 Zone 的前后值
## 6. Rework 数据处理规则
VM 数据中需 剔除 Rework Wafer，以避免破坏工艺因果关系。
判定规则（示例）：
1. 若 FDC数据中的 RECIPE 字段包含 RW 标识，则判定为 Rework Wafer
1. 该 Wafer 的Rework之后的所有 Wafer / Zone 级数据均需剔除
1. 该Wafer Rework之前的数据可以作为训练集的异常数据保留
该规则应根据不同工艺的实际情况调整。
## 7. Trace Data 数据获取规范（通用流程）
### 7.1 触发 Trace Data API 的场景
需通过 Trace Data API 补充数据的情况包括：
1. 统计 Chart 特征存在缺失值
1. 统计 Chart 未配置该参数（如 OpTime、温度等）
### 7.2 Trace Data 获取流程
（1）缺失值检测
（2）参数名映射
1. 将重命名后的特征名映射回 Trace API 所需的原始参数名
1. 构建参数字典：
    1. 参数 ID
    1. 原始参数名
    1. Chamber
（3）取值 Window 规则解析
1. 基于 RECIPE / EQP / Chamber / 参数名匹配 window 规则
1. 支持规则示例：step10B2^step13E5
    1. 含义：
        1. 去除 step10 前 2 秒
        1. 去除 step13 后 5 秒
        1. 对中间区间数据取统计值（如 mean / max）
（4）Trace Data API 调用
（5）数据填充
1. 按 window 规则计算统计值
1. 填充 Wafer 级数据
1. 同步填充对应 Zone 级数据
## 8. 数据处理流程（统一六阶段）
### 阶段一：原始数据输入
1. 输入数据包括：
    1. FDC 原始数据
    1. SPC Pre / Post 数据
1. 每片 Wafer 至少包含：
    1. Wafer基本信息特征
    1. 统计特征
1. 若存在多行记录：
    1. 取最新时间的一行
或
    1. 根据一定规则合并为一行，如一片wafer有多个module
### 阶段二：字段重命名与合并
1. 保留模型所需特征
1. 基于参数映射表重命名字段
1. 合并多行数据为单行
### 阶段三：Zone 划分
1. 基于 AREA 字段拆分 Zone
1. 重新计算 Zone 级 SPC 值
1. 校验每片 Wafer 的 Zone 数完整性
### 阶段四：衍生特征计算
MIX 特征（示例）
1. 乘积

1. 平方

### 阶段五：衍生特征反向校验
1. 基于原始特征反算
1. 若参与计算的原始特征为空，则跳过校验
1. 防止误报
### 阶段六：缺失值填充
1. FDC：
    1. 优先使用同机台 + 同产品历史均值
    1. 否则使用同机台历史均值
1. SPC：
    1. 检查 0 值 / 异常值
    1. 必要时进行填充
